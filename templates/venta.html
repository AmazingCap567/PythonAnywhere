<!-- templates/venta.html -->
{% extends "base.html" %}

{% block title %}Registrar Venta{% endblock %}

{% block content %}
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #e2e2e2;
        margin: 0;
        padding: 0;
    }

    .container {
        width: 900px;
        margin: 30px auto;
        background-color: #f8f8f8;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px gray;
    }

    h2 {
        text-align: center;
        color: #003366;
    }

    label {
        display: inline-block;
        width: 120px;
    }

    input, select {
        margin: 5px;
        padding: 5px;
    }

    .row {
        margin: 10px 0;
    }

    .boton {
        padding: 5px 10px;
        margin-left: 10px;
    }

    table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid gray;
        padding: 8px;
        text-align: center;
    }

    .totales {
        margin-top: 15px;
        text-align: right;
        font-size: 18px;
    }

    .btn-eliminar {
        background-color: red;
        color: white;
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
    }

    #modal {
        display: none;
        position: fixed;
        z-index: 1;
        padding-top: 100px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    #modal-content {
        background-color: #fff;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
    }

    .close {
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
</style>
</head>
<body>
    <div class="container">
        <h2>Registro de Venta</h2>
        <form method="POST">
            <div class="row">
                <label>Cod_Cliente:</label>
                <input type="text" name="cod_cliente" id="cod_cliente" value="{{ cliente.id if cliente else '' }}">
                <button type="button" onclick="mostrarModal()">Buscar</button>
                <button name="registrar_cliente">Registrar Cliente</button>
            </div>
            <div class="row">
                <label>Nombres:</label>
                <input type="text" name="nombre" id="nombre" value="{{ cliente.nombre if cliente else '' }}">
                <label>Apellidos:</label>
                <input type="text" name="apellidos" id="apellidos" value="{{ cliente.apellidos if cliente else '' }}">
            </div>
            <div class="row">
                <label>Dirección:</label>
                <input type="text" name="direccion" id="direccion" value="{{ cliente.direccion if cliente else '' }}">
                <label>RUC:</label>
                <input type="text" name="ruc" id="ruc" value="{{ cliente.ruc if cliente else '' }}">
            </div>
            <div class="row">
                <label>Razón social:</label>
                <input type="text" name="razon_social" id="razon_social" value="{{ cliente.razon_social if cliente else '' }}">
            </div>

            <hr>

            <div class="row">
                <label>Producto:</label>
                <select name="producto" required>
                    {% for p in productos %}
                    <option value="{{ p[0] }}" data-precio="{{ p[3] }}">{{ p[1] }}</option>
                    {% endfor %}
                </select>
                <label>Precio Unitario:</label>
                <input type="text" id="precio" name="precio" readonly>
                <label>Cantidad:</label>
                <input type="number" name="cantidad" min="1" value="1">
                <button class="boton" name="agregar">Agregar</button>
            </div>

            {% if carrito %}
            <table>
                <thead>
                    <tr>
                        <th>Cantidad</th>
                        <th>Producto</th>
                        <th>Precio Unitario</th>
                        <th>Importe</th>
                    </tr>
                </thead>
                <tbody>
                    {% set subtotal = 0 %}
                    {% for item in carrito %}
                    {% set subtotal = subtotal + item.subtotal %}
                    <tr>
                        <td>{{ item.cantidad }}</td>
                        <td>{{ item.nombre }}</td>
                        <td>{{ item.precio_unitario }}</td>
                        <td>{{ item.subtotal }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="totales">
                Subtotal: S/ {{ '%.2f' % subtotal }}<br>
                IGV (18%): S/ {{ '%.2f' % (subtotal * 0.18) }}<br>
                <strong>Total a Pagar: S/ {{ '%.2f' % (subtotal * 1.18) }}</strong>
                <form method="POST" onsubmit="return validarFormulario()">
                    <button class="boton" name="confirmar">Confirmar Venta</button>
                </form>
            </div>
            {% endif %}
        </form>
    </div>

    <div id="modal">
        <div id="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h3>Buscar Cliente</h3>
            <input type="text" id="busqueda" placeholder="Buscar por nombre o RUC...">
            <ul id="resultados"></ul>
        </div>
    </div>

    <script>
        const selectProducto = document.querySelector("select[name='producto']");
        const precioInput = document.getElementById("precio");

        function actualizarPrecio() {
            const selected = selectProducto.options[selectProducto.selectedIndex];
            precioInput.value = selected.getAttribute("data-precio");
        }

        selectProducto.addEventListener("change", actualizarPrecio);
        window.onload = actualizarPrecio;

        function validarFormulario() {
            const nombre = document.getElementById("nombre").value.trim();
            const apellidos = document.getElementById("apellidos").value.trim();
            const ruc = document.getElementById("ruc").value.trim();

            if (!nombre || !apellidos || !ruc) {
                alert("Debe completar Nombre, Apellidos y RUC para continuar.");
                return false;
            }
            return true;
        }

        function mostrarModal() {
            document.getElementById("modal").style.display = "block";
        }

        function cerrarModal() {
            document.getElementById("modal").style.display = "none";
        }

        // Simular resultados de búsqueda (esto debe ser reemplazado con llamada a backend)
        document.getElementById("busqueda").addEventListener("input", function () {
            const query = this.value.trim();
            const ul = document.getElementById("resultados");
            ul.innerHTML = "";

            if (!query) return;

            fetch(`/buscar_clientes?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(clientes => {
                    clientes.forEach(cliente => {
                        const li = document.createElement("li");
                        li.textContent = `${cliente.nombre} ${cliente.apellidos} - ${cliente.ruc}`;
                        li.style.cursor = "pointer";
                        li.onclick = function () {
                            document.getElementById("cod_cliente").value = cliente.id;
                            document.getElementById("nombre").value = cliente.nombre;
                            document.getElementById("apellidos").value = cliente.apellidos;
                            document.getElementById("direccion").value = cliente.direccion;
                            document.getElementById("ruc").value = cliente.ruc;
                            document.getElementById("razon_social").value = cliente.razon_social;
                            cerrarModal();
                        };
                        ul.appendChild(li);
                    });
                });
        });

    </script>

    {% endblock %}
